# AWS buildspec.yml
#
version: 0.2
phases:
  install:
    runtime-versions:
      docker: 18

  build:
    commands:
      - docker-compose up -d
      - npm install -g testcafe

      # OWASP ModSecurity Core Rule Set Container (Apache Reverse Proxy)
      # owasp/modsecurity-crs
      # Environment variables:
      # PARANOIA:   paranoia_level
      # ANOMALYIN:  inbound_anomaly_score_threshold
      # ANOMALYOUT: outbound_anomaly_score_threshold 
      # ALLOWED_METHODS: A string indicating the allowed_methods (Default: GET HEAD POST OPTIONS)
      # See https://coreruleset.org/
      #
      # PROXYLOCATION:    application backend
      # we set inbound and outbound anomaly score to 1, no tolerance
      - docker run -dt --name apachecrstc -p 80:80 -e PARANOIA=2 -e ALLOWED_METHODS='GET HEAD POST OPTIONS PUT' -e ANOMALYIN=1 -e ANOMALYOUT=1 -e PROXYLOCATION=http://172.17.0.1:8000/ owasp/modsecurity-crs:v3.2-modsec2-apache

      # ModSecurity Tuning:
      # See https://www.netnea.com/cms/apache-tutorial-8_handling-false-positives-modsecurity-core-rule-set/
      # We use rule exclusion example files:
      # REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf OR
      # RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf
      - docker cp RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf apachecrstc:/etc/modsecurity.d/owasp-crs/rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf;
      - docker exec apachecrstc /usr/local/apache2/bin/apachectl -f /usr/local/apache2/conf/httpd.conf -k graceful
      # Application Tests with Testcafe
      # skip-js-errors because of: Uncaught Error: Bootstrap tooltips require Tether
      - testcafe "chrome:headless" testcafe/tests/test.js --skip-js-errors

      # Application Tests with CRS with Testcafe
      - testcafe "chrome:headless" testcafe/tests/testcrs.js --skip-js-errors
      #- docker cp testcafe:/tmp/res.xml /tmp/test-results/

      # WAF Tests with malicous request to test WAF itself
      - testcafe "chrome:headless" testcafe/tests/testwaf.js --skip-js-errors

      # Fail if ModSecurity log is not empty
      # Show ModSecurity logs of Testcafe Tests
      - docker exec apachecrstc cat /var/log/apache2/error.log grep ModSecurity #| grep -vi "My evil WAF Test" | grep -v " Score: 30" | grep msg && exit 1 || exit 0

      # If not empty -> Repair your application OR
      #              -> ModSecurity Tuning:
      # See https://www.netnea.com/cms/apache-tutorial-8_handling-false-positives-modsecurity-core-rule-set/ OR
      #              -> GitHub issue: https://github.com/SpiderLabs/owasp-modsecurity-crs
              
      # Fail if ModSecurity log does not contain WAF Test String "My evil WAF Test"
      # '<script>alert("My evil WAF Test")</script>'
      # Search for WAF Test String "My evil WAF Test" in ModSecurity logs
      - docker exec apachecrstc cat /var/log/apache2/error.log
      # If empty -> WAF Test String <script>alert(My evil WAF Test)</script>
      # did not trigger a CRS rule. 
      # That means CRS is not working properly or test was aborted.
#              
#      - store_test_results:
###           path: /tmp/test-results 
